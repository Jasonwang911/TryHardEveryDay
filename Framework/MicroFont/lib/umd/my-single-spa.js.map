{"version":3,"file":"my-single-spa.js","sources":["../../src/applications/apps.helper.js","../../src/start.js","../../src/lifecycles/helper.js","../../src/applications/timeout.js","../../src/lifecycles/load.js","../../src/lifecycles/bootstrap.js","../../src/lifecycles/unmount.js","../../src/lifecycles/mount.js","../../src/navigations/invoke.js","../../src/applications/apps.js"],"sourcesContent":["// 未加载\r\nexport const NOT_LOADED = 'NOT_LOADED';\r\n// 加载app代码中\r\nexport const LOAD_RESOURCE_CODE = 'LOAD_RESOURCE_CODE';\r\n// 加载成功，但未启动\r\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED';\r\n// 启动中\r\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING';\r\n// 启动成功，未挂载\r\nexport const NOT_MOUNTED = 'NOT_MOUNTED';\r\n// 挂载中\r\nexport const MOUNTING = 'MOUNTING';\r\n// 挂载成功\r\nexport const MOUNTED = 'MOUNTED';\r\n// 卸载中\r\nexport const UNMOUNTING = 'UNMOUNTING';\r\n// 加载时参数校验未通过，或非致命错误\r\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN';\r\n// 加载时遇到致命错误\r\nexport const LOAD_ERROR = 'LOAD_ERROR';\r\n// 更新service中\r\nexport const UPDATING = 'UPDATING';\r\n\r\nexport function noSkip(app) {\r\n  return app.status !== SKIP_BECAUSE_BROKEN\r\n}\r\n\r\nexport function noLoadError(app) {\r\n  return app.status !== LOAD_ERROR\r\n}\r\n\r\nexport function isLoaded(app) {\r\n  return app.status !== NOT_LOADED && app.status !== SKIP_BECAUSE_BROKEN && app.status !== LOAD_ERROR\r\n}\r\n\r\nexport function isntLoaded(app) {\r\n  return app.status === NOT_LOADED \r\n}\r\n\r\nexport function isActive(app) {\r\n  return app.status === MOUNTED\r\n}\r\n\r\nexport function isntActive(app) {\r\n  return !isActive(app)\r\n}\r\n\r\nexport function shouldBeActivity(app) {\r\n  try{\r\n    return app.activityWhen(window.location)\r\n  }catch(e) {\r\n    app.status = SKIP_BECAUSE_BROKEN\r\n    console.log(e)\r\n  }\r\n}\r\n","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-05 11:17:18\r\n * @Descripttion:  系统启动状态\r\n */\r\nimport { invoke } from \"./navigations/invoke\"\r\n\r\nlet started = false\r\n\r\nexport function start() {\r\n  if(started) {\r\n    return Promise.resolve()\r\n  }\r\n  started = true\r\n  return invoke()\r\n}\r\n\r\nexport function isStarted() {\r\n  return started\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-17 14:08:40\r\n * @Descripttion: 判断是否是promise和生命周期\r\n */\r\n// 判断是不是Promise\r\nexport function smellLikeAPromise(promise) {\r\n  if(promise instanceof Promise) {\r\n    return true\r\n  }\r\n  return typeof promise === 'object' && typeof promise.then === 'function' && typeof promise.catch === 'function'\r\n}\r\n\r\nexport function flattenLifecycleArray(lifecycle, description) {\r\n  if(!Array.isArray(lifecycle)) {\r\n    lifecycle = [lifecycle]\r\n  }\r\n  if(!lifecycle.length) {\r\n    // 空对象\r\n    lifecycle = [() => Promise.resolve()]\r\n  }\r\n  return props =>  new Promise((resolve,reject) => {\r\n    waitForPromise(0)\r\n    function waitForPromise(index) {\r\n      let fn = lifecycle[index](props)\r\n      if(!smellLikeAPromise(fn)) {\r\n        reject(new Error(`${description} has error`))\r\n      }else {\r\n        fn.then(() => {\r\n          if(index >= lifecycle.length-1) {\r\n            resolve()\r\n          }else {\r\n            waitForPromise(++index)\r\n          }\r\n        }).catch(e => {\r\n          reject(e)\r\n        })\r\n      }\r\n    }\r\n  })\r\n}\r\n\r\nexport function getProps(app) {\r\n  return {\r\n    name: app.name,\r\n    ...app.customProps\r\n  }\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-18 13:31:54\r\n * @Descripttion: 超时处理\r\n */\r\nconst TIMEOUTS = {\r\n  bootstrap: {\r\n    milliseconds: 3000,     // 超时的时间\r\n    rejectWhenTimeout: false    // 超时后是否拒绝   \r\n  },\r\n  mount: {\r\n    milliseconds: 3000,\r\n    rejectWhenTimeout: false\r\n  },\r\n  unmount: {\r\n    milliseconds: 3000,\r\n    rejectWhenTimeout: false\r\n  },\r\n}\r\n\r\n/**\r\n * @name: \r\n * @test: test font\r\n * @msg: \r\n * @lifecyclePromise {Promise} \r\n * @description {string} \r\n * @timeout {data} \r\n * @return: \r\n */\r\nexport function reasonableTime(lifecyclePromise, description, timeout) {\r\n  return new Promise((resolve, reject) => {\r\n    let finished = false\r\n    lifecyclePromise.then((data) => {\r\n      finished = true\r\n      resolve(data)\r\n    }).catch(e => {\r\n      finished = true\r\n      reject(e)\r\n    })\r\n\r\n    setTimeout(() => {\r\n      // 规定时间没有超时\r\n      if(finished) {\r\n        return \r\n      }\r\n      if(timeout.rejectWhenTimeout) {\r\n        reject(`${description}`)\r\n      }else {\r\n        console.log('timeout but waiting')\r\n      }\r\n    }, timeout.milliseconds)\r\n  })\r\n}\r\n\r\nexport function ensureAppTimeout(timeouts={}) {\r\n  return {\r\n  ...TIMEOUTS,\r\n  ...timeouts\r\n  }\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-17 14:02:58\r\n * @Descripttion: \r\n * @version: \r\n */\r\nimport { NOT_LOADED, LOAD_RESOURCE_CODE, SKIP_BECAUSE_BROKEN, LOAD_ERROR, NOT_BOOTSTRAPPED } from \"../applications/apps.helper\";\r\nimport { smellLikeAPromise, flattenLifecycleArray, getProps } from './helper'\r\nimport { ensureAppTimeout } from '../applications/timeout'\r\n\r\n// 加载app\r\nexport function toLoadPromise(app) {\r\n  if(app.status !== NOT_LOADED) {\r\n    return Promise.resolve(app)\r\n  }\r\n  // 修改状态为加载源代码\r\n  app.status = LOAD_RESOURCE_CODE\r\n  // 加载app  getProps() 是获取app相关的描述信息\r\n  let loadPromise = app.loadFunction(getProps(app))\r\n  if(!smellLikeAPromise(loadPromise)) {\r\n    app.status = SKIP_BECAUSE_BROKEN\r\n    return Promise.reject(new Error('loadFuntion must return a Promise or thanable object'))\r\n  }\r\n  return loadPromise.then(appConfig => {\r\n    if(typeof appConfig !== 'object') {\r\n      throw new Error('appConfig must be object')\r\n    }\r\n    // 生命周期  验证生命周期有没有，是不是函数   bootstrap mount unmount \r\n    let errors = []\r\n    let lifecycleArr = ['bootstrap', 'mount', 'unmount']\r\n    lifecycleArr.forEach(lifecycle => {\r\n      if(!appConfig[lifecycle]) {\r\n        errors.push(`lifecycle: ${lifecycle} must be exists`)\r\n      }\r\n    })\r\n    if(errors.length) {\r\n      app.status = SKIP_BECAUSE_BROKEN\r\n      console.log(errors)\r\n      return \r\n    }\r\n    // 修改状态为 not \r\n    app.status = NOT_BOOTSTRAPPED\r\n    // 处理生命周期和超时   需要做reduce处理\r\n    app.bootstrap = flattenLifecycleArray(appConfig.bootstrap, `app: ${app.name} bootstrap`)\r\n    app.mount = flattenLifecycleArray(appConfig.mount, `app: ${app.name} mount`)\r\n    app.unmount = flattenLifecycleArray(appConfig.unmount, `app: ${app.name} unmount`)\r\n    // 超时处理\r\n    app.timeouts = ensureAppTimeout(appConfig.timeouts)\r\n    // console.log(app)\r\n    return app\r\n  }).catch(e => {\r\n    app.status = LOAD_ERROR\r\n    console.log('====>', e)\r\n  })\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-18 19:19:13\r\n * @Descripttion: 启动阶段 \r\n */\r\nimport { NOT_BOOTSTRAPPED, BOOTSTRAPPING, NOT_MOUNTED, SKIP_BECAUSE_BROKEN } from \"../applications/apps.helper\";\r\nimport { reasonableTime } from \"../applications/timeout\";\r\nimport { getProps } from \"./helper\";\r\n\r\nexport function toBootstrapPromise(app) {\r\n  if(app.status !== NOT_BOOTSTRAPPED) {\r\n    return Promise.resolve(app)\r\n  }\r\n  // 变更状态为启动中\r\n  app.status = BOOTSTRAPPING\r\n  // 超时处理\r\n  return reasonableTime(\r\n    app.bootstrap(getProps(app)), \r\n    `app: ${app.name} bootstrapping`, \r\n    app.timeouts.bootstrap\r\n  ).then(() => {\r\n    // 更新状态为 没有被挂在\r\n    app.status = NOT_MOUNTED\r\n    return app\r\n  }).catch(e => {\r\n    app.status = SKIP_BECAUSE_BROKEN\r\n    console.log(e)\r\n    return app\r\n  })\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-18 19:19:26\r\n * @Descripttion: 卸载阶段\r\n */\r\nimport { MOUNTED, UNMOUNTING, NOT_MOUNTED, SKIP_BECAUSE_BROKEN } from \"../applications/apps.helper\";\r\nimport { reasonableTime } from \"../applications/timeout\";\r\nimport { getProps } from \"./helper\";\r\n\r\nexport function toUnmountPromise(app) {\r\n  if(app.status !== MOUNTED) {\r\n    return Promise.resolve(app)\r\n  }\r\n  app.status = UNMOUNTING\r\n  return reasonableTime(\r\n    app.unmount(getProps(app)),\r\n    `app: ${app.name} unmounting`,\r\n    app.timeouts.unmount\r\n  ).then(() => {\r\n    app.status = NOT_MOUNTED\r\n    return app\r\n  }).catch(e => {\r\n    app.status = SKIP_BECAUSE_BROKEN\r\n    console.log(e)\r\n    return app\r\n  })\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-18 19:19:20\r\n * @Descripttion: mount阶段\r\n */\r\nimport { NOT_MOUNTED, MOUNTING, MOUNTED, SKIP_BECAUSE_BROKEN } from \"../applications/apps.helper\";\r\nimport { reasonableTime } from \"../applications/timeout\";\r\nimport { getProps } from \"./helper\";\r\nimport { toUnmountPromise } from \"./unmount\";\r\n\r\nexport function toMountPromise(app) {\r\n  if(app.status !== NOT_MOUNTED) {\r\n    return Promise.resolve(app)\r\n  }\r\n  app.status = MOUNTING\r\n  return reasonableTime(\r\n    app.mount(getProps(app)),\r\n    `app ${app.name} mounting`,\r\n    app.timeouts.mount\r\n  ).then(() => {\r\n    app.status = MOUNTED\r\n    return app\r\n  }).catch(e => {\r\n    // 如果app挂在失败，那么立即执行unmount操作\r\n    app.status = MOUNTED\r\n    // toUnmountPromise\r\n    toUnmountPromise(app)\r\n    console.log(e)\r\n    return app\r\n  })\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-05 13:35:09\r\n * @Descripttion: \r\n */\r\nimport { isStarted } from '../start'    // 判断系统是否启动\r\nimport { getAppsToload, getAppsToUnmount, getAppsToMount, getMountedApps } from '../applications/apps'\r\nimport { toLoadPromise } from '../lifecycles/load'\r\nimport { toBootstrapPromise } from '../lifecycles/bootstrap'\r\nimport { toMountPromise } from '../lifecycles/mount'\r\nimport { toUnmountPromise } from '../lifecycles/unmount'\r\n\r\n// 拿到所有得app\r\nlet appChangesUnderway = false\r\n// 路由改变或者是调用了appChangesUnderway\r\nlet changesQueue = []\r\n\r\n//  pendings 是上一次循环得 changesQueue，finish中调用invoke传入\r\nexport function invoke(pendings = []) {\r\n  // 判断系统是否启动\r\n  if(appChangesUnderway) {\r\n    return new Promise((resolve, reject) => {\r\n      changesQueue.push({\r\n        success: resolve,\r\n        failure: reject\r\n      })\r\n    })\r\n  }\r\n  appChangesUnderway = true\r\n  if(isStarted()) {\r\n    // 启动app\r\n    return preformAppChanges()\r\n  }\r\n  // 加载app 并不执行，相当于预加载\r\n  return loadApps()\r\n\r\n  function loadApps() {\r\n    // 获取需要被加载的app\r\n    return Promise.all(getAppsToload().map(toLoadPromise)).then((apps) => {\r\n      console.log(apps)\r\n      // 加载完成调finish\r\n      return finish()\r\n    }).catch(e => {\r\n      console.log(e)\r\n    })\r\n    // getAppsToload().map(app => {\r\n    //   return toLoadPromise(app)\r\n    // })\r\n  }\r\n\r\n  // 核心逻辑 启动app: 卸载不需要的app,加载需要的app，挂载需要的app\r\n  function preformAppChanges() {\r\n    // 先卸载不需要的app  执行卸载\r\n    // 拿到需要卸载的app，调用toUnmountPromise\r\n    let unmountPromise = getAppsToUnmount().map(toUnmountPromise)\r\n    unmountPromise = Promise.all(unmountPromise)\r\n    // will load app  ===>  getAppsToload().map(toLoadPromise)   \r\n    //  加载完  启动   启动完  mount\r\n    // 拿到需要加载的app，去load， load完成后调用 bootstrap, bootstrap完成并且等unmount完成后再去调用mount（先卸载再加载）\r\n    let loadApps = getAppsToload()\r\n    loadApps.map(app => {\r\n      return toLoadPromise(app).then(function(app) {\r\n        return toBootstrapPromise(app).then(() => unmountPromise).then(() => toMountPromise(app))\r\n      })\r\n    })\r\n    // will mount app   mount不需要load,比上一步操作少了一个load\r\n    let mountApps = getAppsToMount()\r\n    // 去重\r\n    mountApps = mountApps.filter(app => loadApps.indexOf(app) === -1)\r\n    mountApps = mountApps.map(function (app) {\r\n      // 拿到已经加载过并且没有mount的app\r\n      return toBootstrapPromise(app).then(() => unmountPromise).then(() => toMountPromise(app))\r\n    })\r\n\r\n    // unmountPromise\r\n    return unmountPromise.then(() => {\r\n      let allPromises = loadApps.concat(mountApps)\r\n    // 统一去挂载\r\n      return Promise.all(allPromises).then(() => {\r\n        return finish()\r\n      }, e => {\r\n        pendings.forEach(item => item.failure(e))\r\n        throw e;\r\n      })\r\n    }, e => {\r\n      console.log(e)\r\n    })\r\n\r\n    // 针对load和mount的app去重\r\n  }\r\n\r\n  // 事件队列里有值就一直循环 递归掉，如果没有值，就把当前事件队列返回回去\r\n  function finish() {\r\n    // 获取当前已经被加载的app\r\n    let returnValue = getMountedApps()\r\n    if(pendings.length) {\r\n      // 当前被挂载得app\r\n      // promise 状态一旦确定，就无法再修改\r\n      pendings.forEach(item => item.success(returnValue))\r\n    }\r\n    \r\n    // 表示当前循环已经完成\r\n    appChangesUnderway = false\r\n    if(changesQueue.length) {\r\n      // 路由变了 用户掉start方法了\r\n      let backup = changesQueue\r\n      changesQueue = []\r\n      invoke(backup)\r\n    }\r\n\r\n    return returnValue\r\n  }\r\n\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-05 10:13:13\r\n * @Descripttion: \r\n * @version: \r\n */\r\nimport { NOT_LOADED, noSkip, noLoadError, isntLoaded, shouldBeActivity, isActive, isntActive, isLoaded } from './apps.helper'\r\nimport { invoke } from '../navigations/invoke'\r\n\r\nlet APPS = []\r\n\r\n/*\r\n*   注册app\r\n*   @param  {string} appName  要注册app的名称\r\n*   @param  {Function<Promise> | Object} loadFunction  app异步加载函数或app内容\r\n*   @param  {Function<boolean>}  activityWhen 判断该app应该在何时被启动\r\n*   @param  {Object} customProps  自定义配置\r\n*   return Promis\r\n*/\r\nexport function registerApplication(appName, loadFunction, activityWhen, customProps={}) {\r\n  if(!appName || typeof appName !== 'string') {\r\n    throw new Error('appName must be a no-empty string')\r\n  }\r\n  if(!loadFunction) {\r\n    throw new Error('loadFunction must be a function or object')\r\n  }\r\n  if(typeof loadFunction !== 'function') {\r\n    // 如果是object 包装成返回的Promise\r\n    loadFunction = () => Promise.resolve(loadFunction)\r\n  }\r\n  if(typeof activityWhen !== 'function') {\r\n    throw new Error('activityWhen must be a function')\r\n  }\r\n  APPS.push({\r\n    name: appName,\r\n    loadFunction,\r\n    activityWhen,\r\n    customProps,\r\n    // app状态\r\n    status: NOT_LOADED\r\n  })\r\n  console.log(APPS)\r\n  invoke()\r\n}\r\n\r\n\r\nexport function getAppsToload() {\r\n  // 判断需要被加载(load)的App： 没有被跳过，没有加载错误，没有被加载过，需要被加载\r\n  return APPS.filter(noSkip).filter(noLoadError).filter(isntLoaded).filter(shouldBeActivity)\r\n}\r\n\r\n// 卸载app\r\nexport function getAppsToUnmount() {\r\n  return APPS.filter(noSkip).filter(isActive).filter(shouldBeActivity)\r\n}\r\n\r\n// mount app\r\nexport function getAppsToMount() {\r\n  // 没有中断  已经加载过的(isLoaded)   没有被mount的(isntActive)  应该被mount的(shouldBeActivity)\r\n  return APPS.filter(noSkip).filter(isLoaded).filter(isntActive).filter(shouldBeActivity)\r\n}\r\n\r\n// 获取当前已经被挂载的app\r\nexport function getMountedApps() {\r\n  return APPS.filter(app => isActive(app))\r\n}"],"names":["NOT_LOADED","LOAD_RESOURCE_CODE","NOT_BOOTSTRAPPED","BOOTSTRAPPING","NOT_MOUNTED","MOUNTING","MOUNTED","UNMOUNTING","SKIP_BECAUSE_BROKEN","LOAD_ERROR","noSkip","app","status","noLoadError","isLoaded","isntLoaded","isActive","isntActive","shouldBeActivity","activityWhen","window","location","e","console","log","started","start","Promise","resolve","invoke","isStarted","smellLikeAPromise","promise","then","catch","flattenLifecycleArray","lifecycle","description","Array","isArray","length","props","reject","waitForPromise","index","fn","Error","getProps","name","customProps","TIMEOUTS","bootstrap","milliseconds","rejectWhenTimeout","mount","unmount","reasonableTime","lifecyclePromise","timeout","finished","data","setTimeout","ensureAppTimeout","timeouts","toLoadPromise","loadPromise","loadFunction","appConfig","errors","lifecycleArr","forEach","push","toBootstrapPromise","toUnmountPromise","toMountPromise","appChangesUnderway","changesQueue","pendings","success","failure","preformAppChanges","loadApps","all","getAppsToload","map","apps","finish","unmountPromise","getAppsToUnmount","mountApps","getAppsToMount","filter","indexOf","allPromises","concat","item","returnValue","getMountedApps","backup","APPS","registerApplication","appName"],"mappings":"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"}