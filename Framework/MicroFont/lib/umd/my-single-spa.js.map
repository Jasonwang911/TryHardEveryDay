{"version":3,"file":"my-single-spa.js","sources":["../../src/applications/apps.helper.js","../../src/start.js","../../src/lifecycles/helper.js","../../src/lifecycles/load.js","../../src/navigations/invoke.js","../../src/applications/apps.js"],"sourcesContent":["/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-05 11:06:07\r\n * @Descripttion: \r\n * @version: \r\n */\r\nexport const NOT_LOADED = 'NOT_LOADED'\r\nexport const LOAD_SOURCE_CODE = 'LOAD_SOURCE_CODE'   // 加载源代码\r\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN'\r\nexport const LOAD_ERROR = 'LOAD_ERROR'\r\n\r\nexport function noSkip(app) {\r\n  return app.status !== SKIP_BECAUSE_BROKEN\r\n}\r\n\r\nexport function noLoadError(app) {\r\n  return app.status !== LOAD_ERROR\r\n}\r\n\r\nexport function isntLoaded(app) {\r\n  return app.status === NOT_LOADED \r\n}\r\n\r\nexport function shouldBeActivity(app) {\r\n  try{\r\n    return app.activityWhen(window.location)\r\n  }catch(e) {\r\n    app.status = SKIP_BECAUSE_BROKEN\r\n    console.log(e)\r\n  }\r\n}\r\n","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-05 11:17:18\r\n * @Descripttion:  系统启动状态\r\n * @version: \r\n */\r\nlet started = false\r\n\r\nexport function start() {\r\n  \r\n}\r\n\r\nexport function isStarted() {\r\n  return started\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-17 14:08:40\r\n * @Descripttion: \r\n * @version: \r\n */\r\n\r\n// 判断是不是Promise\r\nexport function smellLikeAPromise(promise) {\r\n  if(promise instanceof Promise) {\r\n    return true\r\n  }\r\n  return typeof promise === 'object' && typeof promise.then === 'function' && typeof promise.catch === 'function'\r\n}\r\n\r\nexport function flattenLifecycleArray(lifecycle, description) {\r\n  if(!Array.isArray(lifecycle)) {\r\n    lifecycle = [lifecycle]\r\n  }\r\n  if(!lifecycle.length) {\r\n    // 空对象\r\n    lifecycle = [() => Promise.resolve()]\r\n  }\r\n  return new Promise((resolve,reject) => {\r\n    waitForPromise(0)\r\n    function waitForPromise() {\r\n      let fn = lifecycle[index]()\r\n      if(!smellLikeAPromise(fn)) {\r\n        reject(new Error(`${description} has error`))\r\n      }else {\r\n        fn.then(() => {\r\n          if(index >= lifecycle.length-1) {\r\n            resolve()\r\n          }else {\r\n            waitForPromise(++index)\r\n          }\r\n        }).catch(e => {\r\n          reject(e)\r\n        })\r\n      }\r\n    }\r\n  })\r\n}","import { NOT_LOADED, LOAD_SOURCE_CODE, SKIP_BECAUSE_BROKEN } from \"../applications/apps.helper\";\r\nimport { smellLikeAPromise, flattenLifecycleArray } from './helper'\r\n\r\n// 加载app\r\nexport function toLoadPromise(app) {\r\n  if(app.status !== NOT_LOADED) {\r\n    return Promise.resolve(app)\r\n  }\r\n  // 修改状态为加载源代码\r\n  app.status = LOAD_SOURCE_CODE\r\n  // 加载app \r\n  let loadPromise = app.loadFuntion()\r\n  if(!smellLikeAPromise(loadPromise)) {\r\n    return Promise.reject(new Error('app.loadFuntion not a promise'))\r\n  }\r\n  loadPromise.then(appConfig => {\r\n    if(typeof appConfig !== 'object') {\r\n      throw new Error('')\r\n    }\r\n    // 生命周期  验证生命周期有没有，是不是函数   bootstrap mount unmount \r\n    let errors = []\r\n    ['bootstrap', 'mount', 'unmount'].forEach(lifecycle => {\r\n      if(!appConfig[lifecycle]) {\r\n        errors.push(`lifecycle: ${lifecycle} must be exists`)\r\n      }\r\n    })\r\n    if(errors.length) {\r\n      app.status = SKIP_BECAUSE_BROKEN\r\n      console.log(errors)\r\n      return \r\n    }\r\n    // 处理生命周期和超时   需要做reduce处理\r\n    app.bootstrap = flattenLifecycleArray(appConfig.bootstrap, `app: ${app.name} bootstrap`)\r\n    app.mount = flattenLifecycleArray(appConfig.mount, `app: ${app.name} mount`)\r\n    app.unmount = flattenLifecycleArray(appConfig.unmount, `app: ${app.name} unmount`)\r\n    \r\n  })\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-05 13:35:09\r\n * @Descripttion: \r\n */\r\nimport { isStarted } from '../start'    // 判断系统是否启动\r\nimport { getAppsToload } from '../applications/apps'\r\nimport { toLoadPromise } from '../lifecycles/load'\r\n\r\n// 拿到所有得app\r\nlet appChangesUnderway = false\r\nlet chagesQueue = []\r\n\r\nexport function invoke() {\r\n  // 判断系统是否启动\r\n  if(appChangesUnderway) {\r\n    return new Promise((resolve, reject) => {\r\n      chagesQueue.push({\r\n        success: resolve,\r\n        failure: reject\r\n      })\r\n    })\r\n  }\r\n  appChangesUnderway = true\r\n  if(isStarted()) {\r\n    // 启动app\r\n\r\n  }else {\r\n    // 加载app\r\n    loadApps()\r\n  }\r\n\r\n  function loadApps() {\r\n    // 获取需要被加载的app\r\n    getAppsToload().map(toLoadPromise)\r\n    // console.log(getAppsToload())\r\n  }\r\n\r\n\r\n}","/*\r\n * @Author: Jason wang\r\n * @Date: 2019-12-05 10:13:13\r\n * @Descripttion: \r\n * @version: \r\n */\r\nimport { NOT_LOADED, noSkip, noLoadError, isntLoaded, shouldBeActivity } from './apps.helper'\r\nimport { invoke } from '../navigations/invoke'\r\n\r\nlet APPS = []\r\n\r\n/*\r\n*   注册app\r\n*   @param  {string} appName  要注册app的名称\r\n*   @param  {Function<Promise> | Object} loadFunction  app异步加载函数或app内容\r\n*   @param  {Function<boolean>}  activityWhen 判断该app应该在何时被启动\r\n*   @param  {Object} customProps  自定义配置\r\n*   return Promis\r\n*/\r\nexport function registerApplication(appName, loadFunction, activityWhen, customProps) {\r\n  if(!appName || typeof appName !== 'string') {\r\n    throw new Error('appName must be a non-empty string')\r\n  }\r\n  if(!loadFunction) {\r\n    throw new Error('loadFunction must be a function or object')\r\n  }\r\n  if(typeof loadFunction !== 'function') {\r\n    // 如果是object 包装成返回的Promise\r\n    loadFunction = () => Promise.resolve(loadFunction)\r\n  }\r\n  if(typeof activityWhen !== 'function') {\r\n    throw new Error('activityWhen must be a function')\r\n  }\r\n  APPS.push({\r\n    name: appName,\r\n    loadFunction,\r\n    activityWhen,\r\n    customProps,\r\n    // app状态\r\n    status: NOT_LOADED\r\n  })\r\n  console.log(APPS)\r\n  invoke()\r\n}\r\n\r\n\r\nexport function getAppsToload() {\r\n  // 判断需要被加载(load)的App： 没有被跳过，没有加载错误，没有被加载过，需要被加载\r\n  return APPS.filter(noSkip).filter(noLoadError).filter(isntLoaded).filter(shouldBeActivity)\r\n}"],"names":["NOT_LOADED","LOAD_SOURCE_CODE","SKIP_BECAUSE_BROKEN","LOAD_ERROR","noSkip","app","status","noLoadError","isntLoaded","shouldBeActivity","activityWhen","window","location","e","console","log","start","smellLikeAPromise","promise","Promise","then","catch","flattenLifecycleArray","lifecycle","description","Array","isArray","length","resolve","reject","waitForPromise","fn","index","Error","toLoadPromise","loadPromise","loadFuntion","appConfig","errors","forEach","push","bootstrap","name","mount","unmount","appChangesUnderway","invoke","chagesQueue","loadApps","getAppsToload","map","APPS","registerApplication","appName","loadFunction","customProps","filter"],"mappings":"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"}